<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>御坂19039の温馨小站</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="img/favicon.ico" type="image/x-icon">
    <style>
        /* 新增动态样式 */
        .dynamic-list {
            margin-top: 20px;
        }

        .dynamic-item {
            background: #fff;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .dynamic-time {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .dynamic-content {
            line-height: 1.6;
        }

        /* 首页专属样式 */
        .banner {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .profile-card {
            background: white;
            display: flex;
            align-items: center;
            padding: 30px;
            margin: 20px 0;
            position: relative;
            /* 新让子元素绝对定位相对于此元素 */
        }

        .avatar {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            margin-right: 30px;
            border: 5px solid var(--secondary-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }

        .stat-card {
            background-color: white;
            /* 卡片背景颜色为白色 */
            border-radius: 10px;
            /* 卡片圆角 */
            padding: 15px;
            /* 卡片内边距 */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            /* 卡片阴影效果 */
            text-align: center;
            /* 卡片内文本居中显示 */
        }

        .stat-number {
            color: var(--primary-color);
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        #countdown {
            text-align: right;
            /* 文字右对齐 */
            font-size: 20px;
            margin-top: 20px;
        }

        /* 新增样式，用于显示距离一万粉丝的差值 */
        #fans-difference {
            text-align: right;
            font-size: 20px;
            margin-top: 10px;
        }

        #debut-time {
            text-align: right;
            font-size: 20px;
            margin-top: 10px;
        }

        /* 新增舰长统计卡片样式 */
        #captain-count {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        #captain-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .captain-card {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .captain-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="header-content">
            <div>
                <a href="index.html" class="nav-link">首页</a>
                <a href="About.html" class="nav-link">关于</a>
                <a href="Sound.html" class="nav-link active">语音按钮</a>
                <a href="LiveHistory.html" class="nav-link">往期回放</a>
            </div>
            <div>
                <a href="https://space.bilibili.com/12136555" target="_blank" class="bilibili-btn">个人主页</a>
                <a href="https://live.bilibili.com/8414339" target="_blank" class="bilibili-btn">进入直播间</a>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="banner">
            <h1>⚡御坂19039の温馨小站⚡</h1>
            <p>欢迎来到御坂19039的应援基地！(≧∇≦)ﾉ</p>
        </div>

        <div class="profile-card">
            <img src="img/face.webp" alt="御坂19039" class="avatar">
            <div>
                <h2 style="color: #e91e63; margin-top: 0;">✨ 主播介绍 ✨</h2>
                <p>🎤 B站ID：御坂19039</p>
                <p>🎈出道日期：2024年5月27日</p>
                <p>🌟 直播类型：聊天互动 | 游戏实况 | 才艺展示</p>
                <p>💖 直播时间：不定期直播哦~时间变动会发动态嘟</p>
                <p>📌 个人标签：元气满满 | 超电磁炮 | 治愈系</p>
                <div style="margin-top: 20px;">
                    <a href="https://space.bilibili.com/12136555/" target="_blank" class="bilibili-btn">个人主页</a>
                    <a href="https://live.bilibili.com/8414339/" target="_blank" class="bilibili-btn">直播间</a>
                </div>
            </div>
            <div style="margin-left: auto;">
                <div id="countdown">生日回倒计时：加载中...</div>
                <!-- 新增元素，用于显示已出道时间 -->
                <div id="debut-time">已出道：加载中...</div>
                <!-- 新增元素，用于显示距离一万粉丝的差值 -->
                <div id="fans-difference">距离一万粉丝还差：加载中...</div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>粉丝数量</h3>
                <div class="stat-number loading" id="fans-count"></div>
                <p>持续增长中...</p>
            </div>
            <div class="stat-card">
                <h3>直播间人气</h3>
                <div class="stat-number loading" id="live-popularity"></div>
                <p id="live-status">当前直播状态</p>
            </div>
            <!-- 新增舰长统计卡片 -->
            <div class="stat-card" id="captain-count">
                <h3>舰长数量</h3>
                <div class="stat-number loading" id="captain-number"></div>
                <p>感谢舰长们的支持！</p>
            </div>
        </div>

        <h1>舰长列表</h1>
        <div id="captain-list"></div>

        <!-- 页脚 -->
        <div style="text-align: center; padding: 30px; color: #666;">
            <p>© 2024 御坂19039 应援站 | 粉丝群：769271000</p>
            <p>本站为粉丝自制，与哔哩哔哩官方无关</p>
        </div>

    </div>

    <script>
        // 配置信息
        const CONFIG = {
            UID: 12136555,
            ROOM_ID: 8414339,
            CORS_PROXY: 'https://api.allorigins.win/get?url=', // 备用代理
            REFRESH_INTERVAL: 300000, // 5分钟刷新
            PAGE_SIZE: 10
        };

        // 元素引用
        const elements = {
            fans: document.getElementById('fans-count'),
            popularity: document.getElementById('live-popularity'),
            liveStatus: document.getElementById('live-status'),
            // 新增元素引用
            fansDifference: document.getElementById('fans-difference'),
            debutTime: document.getElementById('debut-time'),
            captain: document.getElementById('captain-number')
        };

        // 通用请求方法
        async function fetchData(url) {
            try {
                const response = await fetch(`${CONFIG.CORS_PROXY}${encodeURIComponent(url)}`);
                if (!response.ok) throw new Error('网络请求失败');

                const data = await response.json();
                return JSON.parse(data.contents);
            } catch (error) {
                console.error('数据获取失败:', error);
                return null;
            }
        }

        // 更新统计数据
        function updateStat(element, value, suffix = '') {
            element.classList.remove('loading');
            if (value === null) {
                element.textContent = '数据暂不可用';
                element.style.color = '#999';
            } else {
                let displayValue;
                if (value >= 10000) {
                    displayValue = `${(value / 10000).toFixed(1)}万${suffix}`;
                } else {
                    displayValue = `${value}${suffix}`;
                }
                element.textContent = displayValue;
                element.style.color = '#e91e63';
            }
        }

        // 加载所有数据
        async function loadAllData() {
            // 粉丝数据
            const fansData = await fetchData(
                `https://api.bilibili.com/x/relation/stat?vmid=${CONFIG.UID}`
            );
            const followerCount = fansData?.data?.follower;
            updateStat(elements.fans, followerCount);

            // 计算距离一万粉丝的差值
            if (followerCount!== null) {
                const difference = 10000 - followerCount;
                if (difference > 0) {
                    elements.fansDifference.textContent = `距离一万粉丝还差：${difference} 粉丝`;
                } else {
                    elements.fansDifference.textContent = '已达到一万粉丝！';
                }
            } else {
                elements.fansDifference.textContent = '数据暂不可用';
            }

            // 直播间数据
            const liveData = await fetchData(
                `https://api.live.bilibili.com/room/v1/Room/get_info?room_id=${CONFIG.ROOM_ID}`
            );
            updateStat(elements.popularity, liveData?.data?.online);
            elements.liveStatus.textContent = liveData?.data?.live_status === 1
               ? '🔴 正在直播中'
                : '⚪️ 当前未开播';

            // 舰长数据
            const captainData = await fetchData(
                `https://api.live.bilibili.com/xlive/app-room/v2/guardTab/topList?roomid=${CONFIG.ROOM_ID}&page=1&ruid=${CONFIG.UID}&page_size=${CONFIG.PAGE_SIZE}`
            );
            const captainCount = captainData?.data?.info?.num || null;
            updateStat(elements.captain, captainCount);
        }

        // 新增倒计时功能
        function updateCountdown() {
            const now = new Date();
            // 可以修改下面这一行来改变目标日期，这里设置为每年的5月27日
            let targetYear = now.getFullYear();
            const targetDate = new Date(targetYear, 4, 27); // 注意：月份是从0开始计数，4代表5月
            if (now > targetDate) {
                targetYear++;
                targetDate.setFullYear(targetYear);
            }
            const timeDiff = targetDate - now;

            if (timeDiff > 0) {
                const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
                const countdownElement = document.getElementById('countdown');
                // 修改显示格式为 “生日回倒计时: 58天:3小时:50分:25秒”
                countdownElement.textContent = `生日回倒计时: ${days}天:${hours}小时:${minutes}分:${seconds}秒`;
            } else {
                const countdownElement = document.getElementById('countdown');
                countdownElement.textContent = '生日回已到！';
            }
        }

        // 计算出道时间
        function calculateDebutTime() {
            const debutDate = new Date(2024, 4, 27); // 出道日期，注意月份从0开始
            const now = new Date();
            const timeDiff = now - debutDate;

            const totalSeconds = Math.floor(timeDiff / 1000);
            const seconds = totalSeconds % 60;
            const totalMinutes = Math.floor(totalSeconds / 60);
            const minutes = totalMinutes % 60;
            const totalHours = Math.floor(totalMinutes / 60);
            const hours = totalHours % 24;
            const totalDays = Math.floor(totalHours / 24);
            const years = Math.floor(totalDays / 365);
            const remainingDays = totalDays % 365;

            let displayText = '';
            if (years >= 1) {
                displayText = `${years}年${remainingDays}天:${hours}小时:${minutes}分:${seconds}秒`;
            } else {
                displayText = `${remainingDays}天:${hours}小时:${minutes}分:${seconds}秒`;
            }

            elements.debutTime.textContent = `已出道：${displayText}`;
        }

        // 去除 HTML 标签的函数
        function stripHtmlTags(str) {
            return str.replace(/<[^>]*>/g, '');
        }

        // 渲染舰长列表
        function renderCaptainList(captains) {
            const captainList = document.getElementById('captain-list');
            captainList.innerHTML = '';
            if (captains && captains.length > 0) {
                captains.forEach(captain => {
                    const card = document.createElement('div');
                    card.classList.add('captain-card');

                    const avatar = document.createElement('img');
                    avatar.classList.add('captain-avatar');
                    // 容错处理，当 face 字段不存在或为空时显示默认图片
                    avatar.src = captain.face || 'default-avatar.png';
                    let displayName = captain.username || '未知舰长';
                    displayName = stripHtmlTags(displayName);
                    avatar.alt = displayName;

                    const name = document.createElement('p');
                    name.textContent = displayName;

                    card.appendChild(avatar);
                    card.appendChild(name);
                    captainList.appendChild(card);
                });
            } else {
                const message = document.createElement('p');
                message.textContent = '暂无舰长信息';
                captainList.appendChild(message);
            }
        }

        // 加载舰长数据
        async function loadCaptainData() {
            const url = `https://api.live.bilibili.com/xlive/app-room/v2/guardTab/topList?roomid=${CONFIG.ROOM_ID}&page=1&ruid=${CONFIG.UID}&page_size=${CONFIG.PAGE_SIZE}`;
            const captainData = await fetchData(url);
            console.log('处理后的舰长数据:', captainData); // 打印处理后的舰长数据
            if (captainData) {
                // 合并 data.list 和 data.top3 中的舰长数据
                const allCaptains = [
                   ...(captainData.data.list || []),
                   ...(captainData.data.top3 || [])
                ];
                renderCaptainList(allCaptains);
            }
        }

        // 初始化倒计时
        updateCountdown();
        setInterval(updateCountdown, 1000);

        // 初始化已出道时间显示
        calculateDebutTime();
        setInterval(calculateDebutTime, 1000);

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            loadAllData();
            setInterval(loadAllData, CONFIG.REFRESH_INTERVAL);
            loadCaptainData();
        });

        // 错误处理
        window.addEventListener('error', (event) => {
            console.error('全局错误:', event.error);
            [elements.fans, elements.popularity, elements.captain].forEach(el => {
                el.textContent = '数据获取失败';
                el.style.color = '#ff0000';
            });
        });
    </script>
</body>

</html>